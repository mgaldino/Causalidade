<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Capítulo 5 Matching | Curso de Inferência Causal</title>
  <meta name="description" content="Capítulo 5 Matching | Curso de Inferência Causal" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Capítulo 5 Matching | Curso de Inferência Causal" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Capítulo 5 Matching | Curso de Inferência Causal" />
  
  
  

<meta name="author" content="Manoel Galdino" />


<meta name="date" content="2025-04-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="experimentos.html"/>
<link rel="next" href="variáveis-instrumentais.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Causalidade</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introdução</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#revisão-de-regressão"><i class="fa fa-check"></i><b>1.1</b> Revisão de Regressão</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#teorema-da-anatomia-da-regressão"><i class="fa fa-check"></i><b>1.1.1</b> Teorema da Anatomia da Regressão</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#inferência"><i class="fa fa-check"></i><b>1.2</b> Inferência</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#referências"><i class="fa fa-check"></i><b>1.3</b> Referências</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html"><i class="fa fa-check"></i><b>2</b> Resultados Potenciais</a>
<ul>
<li class="chapter" data-level="2.1" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#causalidade-e-o-método-comparativo"><i class="fa fa-check"></i><b>2.1</b> Causalidade e o Método Comparativo</a></li>
<li class="chapter" data-level="2.2" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#potential-outcomes"><i class="fa fa-check"></i><b>2.2</b> Potential Outcomes</a></li>
<li class="chapter" data-level="2.3" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#notação"><i class="fa fa-check"></i><b>2.3</b> Notação</a></li>
<li class="chapter" data-level="2.4" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#problema-fundamental-da-inferência-causal"><i class="fa fa-check"></i><b>2.4</b> Problema Fundamental da Inferência Causal</a></li>
<li class="chapter" data-level="2.5" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#estimando"><i class="fa fa-check"></i><b>2.5</b> Estimando</a></li>
<li class="chapter" data-level="2.6" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#estimandos-mais-comuns"><i class="fa fa-check"></i><b>2.6</b> Estimandos Mais Comuns</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#ate"><i class="fa fa-check"></i><b>2.6.1</b> ATE</a></li>
<li class="chapter" data-level="2.6.2" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#att"><i class="fa fa-check"></i><b>2.6.2</b> ATT</a></li>
<li class="chapter" data-level="2.6.3" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#cate"><i class="fa fa-check"></i><b>2.6.3</b> CATE</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#nota-sobre-estimandos"><i class="fa fa-check"></i><b>2.7</b> Nota sobre estimandos</a></li>
<li class="chapter" data-level="2.8" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#exercício---qual-o-estimando-e-o-estimador-se-possível"><i class="fa fa-check"></i><b>2.8</b> Exercício - Qual o estimando e o estimador (se possível)?</a></li>
<li class="chapter" data-level="2.9" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#identificação"><i class="fa fa-check"></i><b>2.9</b> Identificação</a></li>
<li class="chapter" data-level="2.10" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#identificação-do-ate"><i class="fa fa-check"></i><b>2.10</b> Identificação do ATE</a></li>
<li class="chapter" data-level="2.11" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#equações-estruturais"><i class="fa fa-check"></i><b>2.11</b> Equações estruturais</a></li>
<li class="chapter" data-level="2.12" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#modelo-versus-desenho"><i class="fa fa-check"></i><b>2.12</b> Modelo versus Desenho</a></li>
<li class="chapter" data-level="2.13" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#exercício-em-sala"><i class="fa fa-check"></i><b>2.13</b> Exercício em sala</a></li>
<li class="chapter" data-level="2.14" data-path="resultados-potenciais.html"><a href="resultados-potenciais.html#referências-1"><i class="fa fa-check"></i><b>2.14</b> Referências</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="dags.html"><a href="dags.html"><i class="fa fa-check"></i><b>3</b> DAGs</a>
<ul>
<li class="chapter" data-level="3.1" data-path="dags.html"><a href="dags.html#causalidade"><i class="fa fa-check"></i><b>3.1</b> Causalidade</a></li>
<li class="chapter" data-level="3.2" data-path="dags.html"><a href="dags.html#introdução-1"><i class="fa fa-check"></i><b>3.2</b> Introdução</a></li>
<li class="chapter" data-level="3.3" data-path="dags.html"><a href="dags.html#os-tipos-básicos-de-dags"><i class="fa fa-check"></i><b>3.3</b> Os Tipos Básicos de DAGs</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="dags.html"><a href="dags.html#chains"><i class="fa fa-check"></i><b>3.3.1</b> 1. Chains</a></li>
<li class="chapter" data-level="3.3.2" data-path="dags.html"><a href="dags.html#forks"><i class="fa fa-check"></i><b>3.3.2</b> 2. Forks</a></li>
<li class="chapter" data-level="3.3.3" data-path="dags.html"><a href="dags.html#colliders"><i class="fa fa-check"></i><b>3.3.3</b> 3. Colliders</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="dags.html"><a href="dags.html#simulação-no-r-ilustrando-o-collider-bias"><i class="fa fa-check"></i><b>3.4</b> Simulação no R: Ilustrando o Collider Bias</a></li>
<li class="chapter" data-level="3.5" data-path="dags.html"><a href="dags.html#definições"><i class="fa fa-check"></i><b>3.5</b> Definições</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="dags.html"><a href="dags.html#relações-entre-variáveis-nós"><i class="fa fa-check"></i><b>3.5.1</b> Relações entre Variáveis (nós):</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="dags.html"><a href="dags.html#controle-e-ajuste"><i class="fa fa-check"></i><b>3.6</b> Controle e Ajuste</a></li>
<li class="chapter" data-level="3.7" data-path="dags.html"><a href="dags.html#fatorização-da-probabilidade-conjunta"><i class="fa fa-check"></i><b>3.7</b> Fatorização da Probabilidade Conjunta</a></li>
<li class="chapter" data-level="3.8" data-path="dags.html"><a href="dags.html#fatorização-e-dags"><i class="fa fa-check"></i><b>3.8</b> Fatorização e DAGs</a></li>
<li class="chapter" data-level="3.9" data-path="dags.html"><a href="dags.html#fatorização-dags-e-causalidade"><i class="fa fa-check"></i><b>3.9</b> Fatorização, DAGs e Causalidade</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="experimentos.html"><a href="experimentos.html"><i class="fa fa-check"></i><b>4</b> Experimentos</a>
<ul>
<li class="chapter" data-level="4.1" data-path="experimentos.html"><a href="experimentos.html#introdução-2"><i class="fa fa-check"></i><b>4.1</b> Introdução</a></li>
<li class="chapter" data-level="4.2" data-path="experimentos.html"><a href="experimentos.html#experimentos-aleatórios"><i class="fa fa-check"></i><b>4.2</b> Experimentos aleatórios</a></li>
<li class="chapter" data-level="4.3" data-path="experimentos.html"><a href="experimentos.html#restrição-de-exclusão"><i class="fa fa-check"></i><b>4.3</b> Restrição de Exclusão</a></li>
<li class="chapter" data-level="4.4" data-path="experimentos.html"><a href="experimentos.html#tipos-de-experimentos"><i class="fa fa-check"></i><b>4.4</b> Tipos de experimentos</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="experimentos.html"><a href="experimentos.html#aleatorização-de-bernoulli"><i class="fa fa-check"></i><b>4.4.1</b> Aleatorização de Bernoulli</a></li>
<li class="chapter" data-level="4.4.2" data-path="experimentos.html"><a href="experimentos.html#aleatorização-completa"><i class="fa fa-check"></i><b>4.4.2</b> Aleatorização Completa</a></li>
<li class="chapter" data-level="4.4.3" data-path="experimentos.html"><a href="experimentos.html#aleatorização-condicional-block-random-assigment"><i class="fa fa-check"></i><b>4.4.3</b> Aleatorização Condicional (Block Random Assigment)</a></li>
<li class="chapter" data-level="4.4.4" data-path="experimentos.html"><a href="experimentos.html#pensando-aleatorização-em-bloco"><i class="fa fa-check"></i><b>4.4.4</b> Pensando aleatorização em bloco</a></li>
<li class="chapter" data-level="4.4.5" data-path="experimentos.html"><a href="experimentos.html#ate-com-aleatorização-condicional-bloco"><i class="fa fa-check"></i><b>4.4.5</b> ATE com Aleatorização Condicional (Bloco)</a></li>
<li class="chapter" data-level="4.4.6" data-path="experimentos.html"><a href="experimentos.html#aleatorização-em-bloco"><i class="fa fa-check"></i><b>4.4.6</b> Aleatorização em bloco</a></li>
<li class="chapter" data-level="4.4.7" data-path="experimentos.html"><a href="experimentos.html#precisão-da-aleatorização-em-bloco"><i class="fa fa-check"></i><b>4.4.7</b> Precisão da aleatorização em bloco</a></li>
<li class="chapter" data-level="4.4.8" data-path="experimentos.html"><a href="experimentos.html#comparação-de-ses"><i class="fa fa-check"></i><b>4.4.8</b> Comparação de SEs</a></li>
<li class="chapter" data-level="4.4.9" data-path="experimentos.html"><a href="experimentos.html#cluster-randomization"><i class="fa fa-check"></i><b>4.4.9</b> Cluster randomization</a></li>
<li class="chapter" data-level="4.4.10" data-path="experimentos.html"><a href="experimentos.html#tabelas-em-artigos"><i class="fa fa-check"></i><b>4.4.10</b> Tabelas em artigos</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="experimentos.html"><a href="experimentos.html#estimador-ate"><i class="fa fa-check"></i><b>4.5</b> Estimador ATE</a></li>
<li class="chapter" data-level="4.6" data-path="experimentos.html"><a href="experimentos.html#key-takeways"><i class="fa fa-check"></i><b>4.6</b> Key Takeways</a></li>
<li class="chapter" data-level="4.7" data-path="experimentos.html"><a href="experimentos.html#declare-design"><i class="fa fa-check"></i><b>4.7</b> Declare Design</a></li>
<li class="chapter" data-level="4.8" data-path="experimentos.html"><a href="experimentos.html#exercício"><i class="fa fa-check"></i><b>4.8</b> Exercício</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="experimentos.html"><a href="experimentos.html#experimento-com-envio-de-cartões-postais-e-participação-eleitoral"><i class="fa fa-check"></i><b>4.8.1</b> Experimento com envio de cartões-postais e participação eleitoral</a></li>
<li class="chapter" data-level="4.8.2" data-path="experimentos.html"><a href="experimentos.html#experimento-com-anúncios-de-tv-e-participação-eleitoral"><i class="fa fa-check"></i><b>4.8.2</b> Experimento com anúncios de TV e participação eleitoral</a></li>
<li class="chapter" data-level="4.8.3" data-path="experimentos.html"><a href="experimentos.html#exclusão-de-participantes-em-experimentos-de-survey"><i class="fa fa-check"></i><b>4.8.3</b> Exclusão de participantes em experimentos de survey</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="matching.html"><a href="matching.html"><i class="fa fa-check"></i><b>5</b> Matching</a>
<ul>
<li class="chapter" data-level="5.1" data-path="matching.html"><a href="matching.html#introdução-3"><i class="fa fa-check"></i><b>5.1</b> Introdução</a></li>
<li class="chapter" data-level="5.2" data-path="matching.html"><a href="matching.html#propensity-score"><i class="fa fa-check"></i><b>5.2</b> Propensity Score</a></li>
<li class="chapter" data-level="5.3" data-path="matching.html"><a href="matching.html#matching-1"><i class="fa fa-check"></i><b>5.3</b> Matching</a></li>
<li class="chapter" data-level="5.4" data-path="matching.html"><a href="matching.html#suposições-de-identificação"><i class="fa fa-check"></i><b>5.4</b> Suposições de identificação</a></li>
<li class="chapter" data-level="5.5" data-path="matching.html"><a href="matching.html#matching-2"><i class="fa fa-check"></i><b>5.5</b> Matching</a></li>
<li class="chapter" data-level="5.6" data-path="matching.html"><a href="matching.html#matching-exato"><i class="fa fa-check"></i><b>5.6</b> Matching exato</a></li>
<li class="chapter" data-level="5.7" data-path="matching.html"><a href="matching.html#matching-aproximado"><i class="fa fa-check"></i><b>5.7</b> Matching aproximado</a></li>
<li class="chapter" data-level="5.8" data-path="matching.html"><a href="matching.html#viés"><i class="fa fa-check"></i><b>5.8</b> Viés</a></li>
<li class="chapter" data-level="5.9" data-path="matching.html"><a href="matching.html#declare-design-e-matching"><i class="fa fa-check"></i><b>5.9</b> Declare Design e Matching</a>
<ul>
<li class="chapter" data-level="5.9.1" data-path="matching.html"><a href="matching.html#matching-e-propensity-scores"><i class="fa fa-check"></i><b>5.9.1</b> Matching e Propensity scores</a></li>
<li class="chapter" data-level="5.9.2" data-path="matching.html"><a href="matching.html#discovering-a-dgp"><i class="fa fa-check"></i><b>5.9.2</b> Discovering a DGP</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="variáveis-instrumentais.html"><a href="variáveis-instrumentais.html"><i class="fa fa-check"></i><b>6</b> Variáveis Instrumentais</a></li>
<li class="chapter" data-level="7" data-path="desenho-de-regresão-discontínua.html"><a href="desenho-de-regresão-discontínua.html"><i class="fa fa-check"></i><b>7</b> Desenho de Regresão Discontínua</a></li>
<li class="chapter" data-level="8" data-path="diferença-em-diferenças.html"><a href="diferença-em-diferenças.html"><i class="fa fa-check"></i><b>8</b> Diferença em Diferenças</a></li>
<li class="chapter" data-level="9" data-path="synthetic-control.html"><a href="synthetic-control.html"><i class="fa fa-check"></i><b>9</b> Synthetic Control</a>
<ul>
<li class="chapter" data-level="9.1" data-path="synthetic-control.html"><a href="synthetic-control.html#implementação-no-r"><i class="fa fa-check"></i><b>9.1</b> Implementação no R</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="interferência-spillover-e-dinâmica.html"><a href="interferência-spillover-e-dinâmica.html"><i class="fa fa-check"></i><b>10</b> Interferência, spillover e dinâmica</a>
<ul>
<li class="chapter" data-level="10.1" data-path="interferência-spillover-e-dinâmica.html"><a href="interferência-spillover-e-dinâmica.html#suposições-simplifcadoras"><i class="fa fa-check"></i><b>10.1</b> Suposições simplifcadoras</a></li>
<li class="chapter" data-level="10.2" data-path="interferência-spillover-e-dinâmica.html"><a href="interferência-spillover-e-dinâmica.html#po-com-tratamento-de-múltiplos-valores-multi-valued"><i class="fa fa-check"></i><b>10.2</b> PO com tratamento de múltiplos valores (multi-valued)</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="interferência-spillover-e-dinâmica.html"><a href="interferência-spillover-e-dinâmica.html#multi-valued-discreto"><i class="fa fa-check"></i><b>10.2.1</b> Multi-valued discreto</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="interferência-spillover-e-dinâmica.html"><a href="interferência-spillover-e-dinâmica.html#dinâmica"><i class="fa fa-check"></i><b>10.3</b> Dinâmica</a></li>
<li class="chapter" data-level="10.4" data-path="interferência-spillover-e-dinâmica.html"><a href="interferência-spillover-e-dinâmica.html#interferência"><i class="fa fa-check"></i><b>10.4</b> Interferência</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Curso de Inferência Causal</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="matching" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Capítulo 5</span> Matching<a href="matching.html#matching" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introdução-3" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Introdução<a href="matching.html#introdução-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Na aula de hoje, iremos aprender sobre a principal estratégia de “seleção em observáveis”, que é matching. Mas antes, vamos falar de subclassificação ,que é uma técnica mais simples e é útil para introduzir a ideia de matching.</p>
</div>
<div id="propensity-score" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Propensity Score<a href="matching.html#propensity-score" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>O propensity score nada mais é que a probabilidade de uma unidade ser tratada, dada as covariáveis, ou seja, <span class="math inline">\(Pr(D_i = 1| X_i)\)</span>.</p>
<p>A ideia chave para propensity-score vem de um paper de Rosenbaum-Rubin (1983) em que eles mostram que, se a condição 1 de ignorabilidade forte (isto é, <span class="math inline">\(Y_i(1), Y_i(0) \perp D_i|X_i\)</span>) for satisfeita, então também é verdade que a condição <span class="math inline">\(Y_i(1), Y_i(0) \perp D_i|\pi(X_i)\)</span> também é satisfeita. E por que isso é importante? Nós nunca sabemos o verdadeiro modelo que relaciona as convariáveis <span class="math inline">\(X_i\)</span> com <span class="math inline">\(D_i\)</span> e <span class="math inline">\(Y_i\)</span>, de modo que podemos ter algum problema de modelo mal especificado (por exemplo, supomos um modelo linear, quando na verdade é não-linear). Então, em vez de estimar dezenas de modelos, posso condicionar (“controlar”) apenas pelo propensity score <span class="math inline">\(\pi(X_i)\)</span>. A intuição é que o propensity score cria balanceamento entre tratados e não-tratados.</p>
<p>Para ilustrar o poder desse reusltado, vamos considerar um exemplo simulado, em que ignorability forte é satisfeita, mas um modelo mal-especificado gera amostras não-balanceadas e, portanto, estimativas viesadas.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="matching.html#cb1-1" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-2"><a href="matching.html#cb1-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="matching.html#cb1-3" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb1-4"><a href="matching.html#cb1-4" tabindex="-1"></a><span class="fu">library</span>(arm)</span>
<span id="cb1-5"><a href="matching.html#cb1-5" tabindex="-1"></a><span class="co"># true DGP</span></span>
<span id="cb1-6"><a href="matching.html#cb1-6" tabindex="-1"></a>dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb1-7"><a href="matching.html#cb1-7" tabindex="-1"></a>  y <span class="sc">~</span> D <span class="sc">+</span> w1,</span>
<span id="cb1-8"><a href="matching.html#cb1-8" tabindex="-1"></a>  D <span class="sc">~</span> w1</span>
<span id="cb1-9"><a href="matching.html#cb1-9" tabindex="-1"></a>)</span>
<span id="cb1-10"><a href="matching.html#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="matching.html#cb1-11" tabindex="-1"></a><span class="fu">ggdag</span>(dag)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/modelo-mal-especificado-DAG-1.png" width="672" /></p>
<p>O DAG acima ilustra bem qual a relação causal entre variáveis. Para estimar o ATE de <span class="math inline">\(D\)</span> sobre <span class="math inline">\(Y\)</span>, precisamos fechar o backdoor de <span class="math inline">\(w_1\)</span>. A forma usual como fazemos isso é com regressão. O problema que estamos abordando aqui é quando a amostra é não-balanceada entre tratados e não-tratados, isto é. Vamos visualizar dois tipos de relações (uma linear e outra não-linear) entre a variável de controle <span class="math inline">\(w_1\)</span> e a resposta <span class="math inline">\(Y\)</span> para ilustrar o problema do desbalanceamento:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="matching.html#cb2-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-2"><a href="matching.html#cb2-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">202</span>)</span>
<span id="cb2-3"><a href="matching.html#cb2-3" tabindex="-1"></a>n  <span class="ot">&lt;-</span> <span class="fl">1e4</span></span>
<span id="cb2-4"><a href="matching.html#cb2-4" tabindex="-1"></a>w1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)                       <span class="co"># único confundidor</span></span>
<span id="cb2-5"><a href="matching.html#cb2-5" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">3</span>                             <span class="co"># efeito causal verdadeiro</span></span>
<span id="cb2-6"><a href="matching.html#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="matching.html#cb2-7" tabindex="-1"></a><span class="co"># GERAMOS UM PROPENSITY SCORE NÃO‐LINEAR</span></span>
<span id="cb2-8"><a href="matching.html#cb2-8" tabindex="-1"></a>p  <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> w1) </span>
<span id="cb2-9"><a href="matching.html#cb2-9" tabindex="-1"></a>D  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p)</span>
<span id="cb2-10"><a href="matching.html#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="matching.html#cb2-11" tabindex="-1"></a><span class="co"># GERAÇÃO DOS RESULTADOS POTENCIAIS linear (apenas função de w1, forte ignorabilidade):</span></span>
<span id="cb2-12"><a href="matching.html#cb2-12" tabindex="-1"></a>y0 <span class="ot">&lt;-</span>  <span class="dv">5</span> <span class="sc">*</span> w1 <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-13"><a href="matching.html#cb2-13" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0 <span class="sc">-</span> tau                       <span class="co"># efeito constante</span></span>
<span id="cb2-14"><a href="matching.html#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="matching.html#cb2-15" tabindex="-1"></a>y  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D <span class="sc">==</span> <span class="dv">1</span>, y1, y0)</span>
<span id="cb2-16"><a href="matching.html#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a href="matching.html#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="matching.html#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="matching.html#cb2-19" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y=</span>y, <span class="at">D=</span>D, <span class="at">w1=</span>w1)</span>
<span id="cb2-20"><a href="matching.html#cb2-20" tabindex="-1"></a></span>
<span id="cb2-21"><a href="matching.html#cb2-21" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb2-22"><a href="matching.html#cb2-22" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-23"><a href="matching.html#cb2-23" tabindex="-1"></a>    <span class="at">D =</span> <span class="fu">factor</span>(D, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb2-24"><a href="matching.html#cb2-24" tabindex="-1"></a>               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span>, <span class="st">&quot;Tratado (D = 1)&quot;</span>))</span>
<span id="cb2-25"><a href="matching.html#cb2-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="matching.html#cb2-26" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> w1, <span class="at">y =</span> y, <span class="at">colour =</span> D)) <span class="sc">+</span></span>
<span id="cb2-27"><a href="matching.html#cb2-27" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb2-28"><a href="matching.html#cb2-28" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb2-29"><a href="matching.html#cb2-29" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">&quot;Tratamento (binário)&quot;</span>,</span>
<span id="cb2-30"><a href="matching.html#cb2-30" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span> <span class="ot">=</span> <span class="st">&quot;steelblue&quot;</span>, </span>
<span id="cb2-31"><a href="matching.html#cb2-31" tabindex="-1"></a>               <span class="st">&quot;Tratado (D = 1)&quot;</span>  <span class="ot">=</span> <span class="st">&quot;firebrick&quot;</span>)</span>
<span id="cb2-32"><a href="matching.html#cb2-32" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/modelo-mal-especificado-plot1-1.png" width="672" /></p>
<p>No primeiro gráfico, o efeito causal (ATE) do tratamento é <span class="math inline">\(-3\)</span> e podemos ver nos dados que de fato em média a resposta é menor entre tratados que no controle. Além disso, vemos também que o efeito é basicamente linear. Mas o pontpo importante aqui é que existem duas regiões dos dados em que praticamente só temos unidades no controle (<span class="math inline">\(w_1 &lt; -2\)</span>) e ou no tratamento (<span class="math inline">\(w_1 &gt; -2\)</span>). Isso significa que para que a regressão possa estimar o efeito causal deve extrapolar a estimativa da região em que ambos tratamento e controle estão presentes nos dados para uma região em que não estão presentes. Como o efeito é constante para todas as regiões de <span class="math inline">\(w_1\)</span>, isso não causa problema e a regressão consegue recuperar o ATE sem viés. O gráfico abaixo ilustra o que a regressão está fazendo:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="matching.html#cb3-1" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="matching.html#cb3-2" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-3"><a href="matching.html#cb3-3" tabindex="-1"></a>    <span class="at">D =</span> <span class="fu">factor</span>(D, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb3-4"><a href="matching.html#cb3-4" tabindex="-1"></a>               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span>, <span class="st">&quot;Tratado (D = 1)&quot;</span>))</span>
<span id="cb3-5"><a href="matching.html#cb3-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="matching.html#cb3-6" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> w1, <span class="at">y =</span> y, <span class="at">colour =</span> D)) <span class="sc">+</span></span>
<span id="cb3-7"><a href="matching.html#cb3-7" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb3-8"><a href="matching.html#cb3-8" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-9"><a href="matching.html#cb3-9" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb3-10"><a href="matching.html#cb3-10" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">&quot;Tratamento (binário)&quot;</span>,</span>
<span id="cb3-11"><a href="matching.html#cb3-11" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span> <span class="ot">=</span> <span class="st">&quot;steelblue&quot;</span>, </span>
<span id="cb3-12"><a href="matching.html#cb3-12" tabindex="-1"></a>               <span class="st">&quot;Tratado (D = 1)&quot;</span>  <span class="ot">=</span> <span class="st">&quot;firebrick&quot;</span>)</span>
<span id="cb3-13"><a href="matching.html#cb3-13" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/modelo-mal-especificado-plot1-reg-1.png" width="672" /></p>
<p>O gráfico mostra duas retas de regressão ajustadas, uma para o controle (em azul) e outra para o tratamento (em vermelho). Efetivamente, temos de estender as duas retas para as regiões em que não há dados, por meio de extrapolação, que no caso significa continuar a linha reta. Assim, temos uma estimativa dos resultados potenciais nessas regiões e podemos computar o efeito causal médio. Como a extrapolação é razoável, não há problema.</p>
<p>Vejamos agora uma situação em que o efeito de <span class="math inline">\(w_1\)</span> é não linear sobre <span class="math inline">\(Y\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="matching.html#cb4-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">202</span>)</span>
<span id="cb4-2"><a href="matching.html#cb4-2" tabindex="-1"></a>n  <span class="ot">&lt;-</span> <span class="fl">1e4</span></span>
<span id="cb4-3"><a href="matching.html#cb4-3" tabindex="-1"></a>w1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)                       <span class="co"># único confundidor</span></span>
<span id="cb4-4"><a href="matching.html#cb4-4" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">3</span>                             <span class="co"># efeito causal verdadeiro</span></span>
<span id="cb4-5"><a href="matching.html#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="matching.html#cb4-6" tabindex="-1"></a><span class="co"># GERAMOS UM PROPENSITY SCORE NÃO‐LINEAR</span></span>
<span id="cb4-7"><a href="matching.html#cb4-7" tabindex="-1"></a>p  <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> w1) </span>
<span id="cb4-8"><a href="matching.html#cb4-8" tabindex="-1"></a>D  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p)</span>
<span id="cb4-9"><a href="matching.html#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="matching.html#cb4-10" tabindex="-1"></a><span class="co"># GERAÇÃO DOS RESULTADOS POTENCIAIS não-linear (apenas função de w1, forte ignorabilidade):</span></span>
<span id="cb4-11"><a href="matching.html#cb4-11" tabindex="-1"></a>y0 <span class="ot">&lt;-</span>  <span class="dv">5</span> <span class="sc">*</span> w1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb4-12"><a href="matching.html#cb4-12" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0 <span class="sc">-</span> tau                       <span class="co"># efeito constante</span></span>
<span id="cb4-13"><a href="matching.html#cb4-13" tabindex="-1"></a></span>
<span id="cb4-14"><a href="matching.html#cb4-14" tabindex="-1"></a>y  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D <span class="sc">==</span> <span class="dv">1</span>, y1, y0)</span>
<span id="cb4-15"><a href="matching.html#cb4-15" tabindex="-1"></a></span>
<span id="cb4-16"><a href="matching.html#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="matching.html#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="matching.html#cb4-18" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y=</span>y, <span class="at">D=</span>D, <span class="at">w1=</span>w1)</span>
<span id="cb4-19"><a href="matching.html#cb4-19" tabindex="-1"></a></span>
<span id="cb4-20"><a href="matching.html#cb4-20" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="matching.html#cb4-21" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-22"><a href="matching.html#cb4-22" tabindex="-1"></a>    <span class="at">D =</span> <span class="fu">factor</span>(D, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb4-23"><a href="matching.html#cb4-23" tabindex="-1"></a>               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span>, <span class="st">&quot;Tratado (D = 1)&quot;</span>))</span>
<span id="cb4-24"><a href="matching.html#cb4-24" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="matching.html#cb4-25" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> w1, <span class="at">y =</span> y, <span class="at">colour =</span> D)) <span class="sc">+</span></span>
<span id="cb4-26"><a href="matching.html#cb4-26" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb4-27"><a href="matching.html#cb4-27" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb4-28"><a href="matching.html#cb4-28" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">&quot;Tratamento (binário)&quot;</span>,</span>
<span id="cb4-29"><a href="matching.html#cb4-29" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span> <span class="ot">=</span> <span class="st">&quot;steelblue&quot;</span>, </span>
<span id="cb4-30"><a href="matching.html#cb4-30" tabindex="-1"></a>               <span class="st">&quot;Tratado (D = 1)&quot;</span>  <span class="ot">=</span> <span class="st">&quot;firebrick&quot;</span>)</span>
<span id="cb4-31"><a href="matching.html#cb4-31" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/modelo-mal-especificado-plot2-1.png" width="672" /></p>
<p>Aqui, vemos que o efeito é não-linear de <span class="math inline">\(w_1\)</span> sobre <span class="math inline">\(Y\)</span> e também o desbalanceamento na amostra. Vamos ver o mesmo gráfico com as duas retas ajustadas para entender como a extrapolação pode ficar bem ruim nesse caso.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="matching.html#cb5-1" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="matching.html#cb5-2" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-3"><a href="matching.html#cb5-3" tabindex="-1"></a>    <span class="at">D =</span> <span class="fu">factor</span>(D, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb5-4"><a href="matching.html#cb5-4" tabindex="-1"></a>               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span>, <span class="st">&quot;Tratado (D = 1)&quot;</span>))</span>
<span id="cb5-5"><a href="matching.html#cb5-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="matching.html#cb5-6" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> w1, <span class="at">y =</span> y, <span class="at">colour =</span> D)) <span class="sc">+</span></span>
<span id="cb5-7"><a href="matching.html#cb5-7" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb5-8"><a href="matching.html#cb5-8" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb5-9"><a href="matching.html#cb5-9" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb5-10"><a href="matching.html#cb5-10" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">&quot;Tratamento (binário)&quot;</span>,</span>
<span id="cb5-11"><a href="matching.html#cb5-11" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Controle (D = 0)&quot;</span> <span class="ot">=</span> <span class="st">&quot;steelblue&quot;</span>, </span>
<span id="cb5-12"><a href="matching.html#cb5-12" tabindex="-1"></a>               <span class="st">&quot;Tratado (D = 1)&quot;</span>  <span class="ot">=</span> <span class="st">&quot;firebrick&quot;</span>)</span>
<span id="cb5-13"><a href="matching.html#cb5-13" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/modelo-mal-especificado-plot2-reg-1.png" width="672" /></p>
<p>Um problema óbvio do modelo é que o efeito de w1 é quadrático, então podemos tentar corrigir isso incluindo um termo quadrático.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="matching.html#cb6-1" tabindex="-1"></a>reg_sq <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> w1 <span class="sc">+</span> w1<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> df)</span>
<span id="cb6-2"><a href="matching.html#cb6-2" tabindex="-1"></a><span class="fu">summary</span>(reg_sq)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + w1 + w1^2, data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -8.567 -4.180 -2.347  1.646 73.841 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4.2689     0.1041  40.995  &lt; 2e-16 ***
## D            -1.2953     0.1804  -7.181 7.44e-13 ***
## w1           -0.7960     0.0890  -8.943  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 7.052 on 9997 degrees of freedom
## Multiple R-squared:  0.03237,    Adjusted R-squared:  0.03217 
## F-statistic: 167.2 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>O efeito causal é negativo, o que é bom, pois está na direção certa, mas ainda está distante do efeito verdadeiro. Isso ilustra também como a estimativa é dependente do modelo, o que é bem ruim, pois não sabemos qual o modelo certo.</p>
<p>Em resumo, quando há desbalancamento, causamos dependência do modelo, o que é problemático.</p>
<p>Agora, vamos comparar com o propensity score:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="matching.html#cb8-1" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb8-2"><a href="matching.html#cb8-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb8-3"><a href="matching.html#cb8-3" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb8-4"><a href="matching.html#cb8-4" tabindex="-1"></a><span class="co"># true DGP</span></span>
<span id="cb8-5"><a href="matching.html#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="matching.html#cb8-6" tabindex="-1"></a>reg_aux<span class="ot">&lt;-</span> <span class="fu">glm</span>(D  <span class="sc">~</span> w1, <span class="at">family =</span> binomial, <span class="at">data=</span>df)</span>
<span id="cb8-7"><a href="matching.html#cb8-7" tabindex="-1"></a>p_score <span class="ot">&lt;-</span> reg_aux<span class="sc">$</span>fitted.values</span>
<span id="cb8-8"><a href="matching.html#cb8-8" tabindex="-1"></a>reg1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> p_score)</span>
<span id="cb8-9"><a href="matching.html#cb8-9" tabindex="-1"></a><span class="fu">summary</span>(reg1)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + p_score)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -7.921 -4.258 -2.462  1.647 70.708 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4.2799     0.1179  36.307  &lt; 2e-16 ***
## D            -2.9562     0.1858 -15.910  &lt; 2e-16 ***
## p_score       1.6681     0.2917   5.718 1.11e-08 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 7.069 on 9997 degrees of freedom
## Multiple R-squared:  0.02781,    Adjusted R-squared:  0.02761 
## F-statistic:   143 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="matching.html#cb10-1" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>p_score, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p_score))   <span class="co"># pesos IPTW</span></span>
<span id="cb10-2"><a href="matching.html#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="matching.html#cb10-3" tabindex="-1"></a>reg2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D , <span class="at">weights =</span> w)</span>
<span id="cb10-4"><a href="matching.html#cb10-4" tabindex="-1"></a><span class="fu">summary</span>(reg2)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D, weights = w)
## 
## Weighted Residuals:
##    Min     1Q Median     3Q    Max 
## -15.95  -5.52  -2.87   2.04 324.89 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  4.67183    0.09553   48.90   &lt;2e-16 ***
## D           -2.57016    0.13452  -19.11   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 9.499 on 9998 degrees of freedom
## Multiple R-squared:  0.03523,    Adjusted R-squared:  0.03513 
## F-statistic: 365.1 on 1 and 9998 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Conseguimos recuperar o ATE sem problemas. E não precisei especificar corretamente a forma funcional da variáveil de controle <span class="math inline">\(w_1\)</span> no modelo principal, pois usei o propensity score. Note que precisei modelar corretamente a regreessão que calcula o propensity score.</p>
<p>É útil ver como o pscore está distribuído entre os grupos de tratamento e controle:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="matching.html#cb12-1" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb12-2"><a href="matching.html#cb12-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-3"><a href="matching.html#cb12-3" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb12-4"><a href="matching.html#cb12-4" tabindex="-1"></a><span class="co"># true DGP</span></span>
<span id="cb12-5"><a href="matching.html#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="matching.html#cb12-6" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="matching.html#cb12-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pscore =</span> p_score)</span>
<span id="cb12-8"><a href="matching.html#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="matching.html#cb12-9" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="matching.html#cb12-10" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(pscore, <span class="at">group=</span>D)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/distribuicao-pscore-1.png" width="672" /></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="matching.html#cb13-1" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="matching.html#cb13-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">D =</span> <span class="fu">as.factor</span>(D)) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="matching.html#cb13-3" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb13-4"><a href="matching.html#cb13-4" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x=</span>pscore, <span class="at">group=</span>D, <span class="at">colour =</span> D))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/distribuicao-pscore-2.png" width="672" /></p>
<p>Há desbalanceamento e falta de overlap ou suporte comum, o que leva à extrapolação.</p>
</div>
<div id="matching-1" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Matching<a href="matching.html#matching-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A Ideia do matching pode ser ilustrada se notarmos o seguinte. A projeção da reta vermelha para pontos abaixo de <span class="math inline">\(-2\)</span> é de um <span class="math inline">\(y\)</span> médio muito baixo, enquanto que o <span class="math inline">\(y\)</span> médio é muito alto para o controle. O oposto é verificado para a região em que <span class="math inline">\(w_1 &gt; 2\)</span>. Portanto, se eu restringir (excluir os casos) a análise para uma região onde a necessidade de extrapolação é menor, o resultado tende a ser aproximar do ATE</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="matching.html#cb14-1" tabindex="-1"></a>reg_sub <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> w1, <span class="at">data =</span> df)</span>
<span id="cb14-2"><a href="matching.html#cb14-2" tabindex="-1"></a><span class="fu">summary</span>(reg_sub)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + w1, data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -8.567 -4.180 -2.347  1.646 73.841 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4.2689     0.1041  40.995  &lt; 2e-16 ***
## D            -1.2953     0.1804  -7.181 7.44e-13 ***
## w1           -0.7960     0.0890  -8.943  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 7.052 on 9997 degrees of freedom
## Multiple R-squared:  0.03237,    Adjusted R-squared:  0.03217 
## F-statistic: 167.2 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="matching.html#cb16-1" tabindex="-1"></a>reg_sub <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> w1, <span class="at">data =</span> <span class="fu">subset</span>(df, w1 <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">&amp;</span> w1 <span class="sc">&lt;</span> <span class="dv">2</span>))</span>
<span id="cb16-2"><a href="matching.html#cb16-2" tabindex="-1"></a><span class="fu">summary</span>(reg_sub)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + w1, data = subset(df, w1 &gt; -2 &amp; w1 &lt; 2))
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -7.172 -3.197 -1.537  1.892 17.784 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  3.46278    0.06855  50.517  &lt; 2e-16 ***
## D           -1.98658    0.11897 -16.698  &lt; 2e-16 ***
## w1          -0.35344    0.06647  -5.317 1.08e-07 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 4.582 on 9554 degrees of freedom
## Multiple R-squared:  0.0636, Adjusted R-squared:  0.0634 
## F-statistic: 324.5 on 2 and 9554 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="matching.html#cb18-1" tabindex="-1"></a>reg_sub <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> w1, <span class="at">data =</span> <span class="fu">subset</span>(df, w1 <span class="sc">&gt;</span> <span class="sc">-</span><span class="fl">1.5</span> <span class="sc">&amp;</span> w1 <span class="sc">&lt;</span> <span class="fl">1.5</span>))</span>
<span id="cb18-2"><a href="matching.html#cb18-2" tabindex="-1"></a><span class="fu">summary</span>(reg_sub)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + w1, data = subset(df, w1 &gt; -1.5 &amp; w1 &lt; 1.5))
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.8241 -2.2643 -0.8373  1.6466 10.7901 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.57120    0.04674  55.016  &lt; 2e-16 ***
## D           -2.47756    0.08049 -30.782  &lt; 2e-16 ***
## w1          -0.20525    0.05296  -3.875 0.000107 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.058 on 8674 degrees of freedom
## Multiple R-squared:  0.1553, Adjusted R-squared:  0.1551 
## F-statistic: 797.4 on 2 and 8674 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="matching.html#cb20-1" tabindex="-1"></a>reg_sub <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> w1, <span class="at">data =</span> <span class="fu">subset</span>(df, w1 <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span> w1 <span class="sc">&lt;</span> <span class="dv">1</span>))</span>
<span id="cb20-2"><a href="matching.html#cb20-2" tabindex="-1"></a><span class="fu">summary</span>(reg_sub)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + w1, data = subset(df, w1 &gt; -1 &amp; w1 &lt; 1))
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.3868 -1.2707 -0.2359  1.1639  6.2007 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.41474    0.02854  49.572  &lt; 2e-16 ***
## D           -2.76694    0.04831 -57.274  &lt; 2e-16 ***
## w1          -0.16879    0.04300  -3.925 8.74e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.728 on 6855 degrees of freedom
## Multiple R-squared:  0.3968, Adjusted R-squared:  0.3966 
## F-statistic:  2254 on 2 and 6855 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="matching.html#cb22-1" tabindex="-1"></a>reg_sub <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> w1, <span class="at">data =</span> <span class="fu">subset</span>(df, w1 <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span> w1 <span class="sc">&lt;</span> <span class="dv">1</span>))</span>
<span id="cb22-2"><a href="matching.html#cb22-2" tabindex="-1"></a><span class="fu">summary</span>(reg_sub)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ D + w1, data = subset(df, w1 &gt; -1 &amp; w1 &lt; 1))
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.3868 -1.2707 -0.2359  1.1639  6.2007 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.41474    0.02854  49.572  &lt; 2e-16 ***
## D           -2.76694    0.04831 -57.274  &lt; 2e-16 ***
## w1          -0.16879    0.04300  -3.925 8.74e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.728 on 6855 degrees of freedom
## Multiple R-squared:  0.3968, Adjusted R-squared:  0.3966 
## F-statistic:  2254 on 2 and 6855 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>A ideia do matching é um pouco diferente do que fizemos acima, pois estamos excluindo as observações que estão no tratamento e que não possuem controle correspondente, e do controle que não possuem tratamento correspondente. Não há erro em excluir os dois tipos de observações, mas sempre temos de nos perguntar qual é o estimando de interesse. Se faço esse procedimento, o meu estimando não é nenhum dos usuais ATT ou ATE.</p>
<p>No matchingf, nós nos concentramos em estimar o ATT, de forma que procuramos achar observações no controle que são próximas das tratadas, ou seja, excluímos os controles que não são um match para as observações tratadas.</p>
</div>
<div id="suposições-de-identificação" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Suposições de identificação<a href="matching.html#suposições-de-identificação" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Supondo para simplificar um tratamento binário <span class="math inline">\(T\)</span>, e uma covariável categórica <span class="math inline">\(X\)</span>, temos:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\((Y^1, Y^0) \indep T|X \text{ (Independência Condicional)}\)</span></p></li>
<li><p><span class="math inline">\(0 &lt; P(T=1|A) &lt; 1 \text{ (Suporte comum)}\)</span></p></li>
</ol>
<p>Temos então a seguinte derivação (usando o fato de os resultados potenciais são independentes do <em>treatment assignment</em>, condicional à covariável) e a <em>switching equation</em> no último passo:</p>
<p><span class="math display">\[\begin{align}
   \mathbb{E}[Y^1-Y^0|X] &amp; = \mathbb{E}[Y^1 - Y^0 | X, T=1] \\
            &amp; = \mathbb{E}[Y^1| X, T=1] - \mathbb{E}[Y^0| X,T=0] \\
            &amp; = \mathbb{E}[Y| X, D=1] - \mathbb{E}[Y| X, D=0]
\end{align}\]</span></p>
<p>E o estimador que usamos pode ser representado (supondo suporte comum) como:</p>
<p><span class="math inline">\(\widehat{\delta_{ATE}} = \sum_{x\in X}{(\mathbb{E}[Y| X=x, D=1] - \mathbb{E}[Y| X=x, D=0])P(X=x)}\)</span></p>
<p>E o que estamos fazendo é computar a média do efeito do tratamento condicional ponderado pela distribuição de <span class="math inline">\(X\)</span>.</p>
<p>Para identificar o ATE, nós precisamos supor independência condicional a ambos os resultados potenciais. Se porém isso for crível apenas para <span class="math inline">\(Y^0\)</span>, podemos estimar o ATT. Basta lembrarmos que <span class="math inline">\(\mathbb{E}[Y_i|T_i=1] - \mathbb{E}[Y_i|T_i=0] =  \mathbb{E}[Y_i^1 - Y_i^0|T_i=1] + \mathbb{E}[Y_i^0|T_i=1] - \mathbb{E}[Y_i^0|T_i=0]\)</span></p>
</div>
<div id="matching-2" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Matching<a href="matching.html#matching-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A técnica de matching trata os resultados potenciais como <em>missing data</em>. Assim, pudermos supor CIA com credibilidade, pelo menos com relação a <span class="math inline">\(Y^0\)</span>, então podemos imputar esses resultados potenciais e estimar o ATT. A ideia é achar uma unidade a mais similar possível a unidade tratada para servir como contrafactual. Assim, poderíamos computar “diretamente” o ATT, já que teríamos os <span class="math inline">\(Y^1\)</span> e <span class="math inline">\(Y^0\)</span> para cada unidade, este último imputado.</p>
<p>Há dois grandes grupos de métodos de matching: exato e aproximado.</p>
</div>
<div id="matching-exato" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Matching exato<a href="matching.html#matching-exato" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Nesse método, nós achamos uma unidade (ou mais) que tenham um valor exatamente igual nas covariáveis (ou no propensity score), e imputamos o controle.</p>
</div>
<div id="matching-aproximado" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Matching aproximado<a href="matching.html#matching-aproximado" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Para aproximar o matching, utilizamos alguma noção de distância entre variáveis. Para mais de uma variável, podemos utilizar algumas métricas de distância. A primeira é a distância euclidiana (supondo <span class="math inline">\(K\)</span> variáveis).</p>
<p><span class="math display">\[
\lVert X_i - X_j \rVert = \sqrt{(X_i - X_j)&#39;(X_i - X_j)}
\]</span>
<span class="math display">\[
\lVert X_i - X_j \rVert = \sqrt{\sum_{n=1}^k(X_{ni} - X_{nj})}
\]</span>
A distância euclidiana utiliza a escala das próprias variáveis, então é comum usar a distância euclidiana normalizada:</p>
<p><span class="math display">\[
\lVert X_i - X_j \rVert = \sqrt{\sum_{n=1}^k(\frac{X_{ni} - X_{nj})}{\hat{\sigma}_n^2}}
\]</span>
Outra métrica muito usada é a distância de Mahalanobis, que basicamente divide pela covariância (amostral) entre as variáveis em vez da variância.</p>
</div>
<div id="viés" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Viés<a href="matching.html#viés" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Uma vez que fizemos o matching entre unidades, qual nosso estimador? Lemrbando que o estimando é o ATT.
<span class="math display">\[
\widehat{\delta}_{ATT} = \dfrac{1}{N_T} \sum_{D_i=1} (Y_i - Y_{j(i)})
\]</span></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="matching.html#cb24-1" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb24-2"><a href="matching.html#cb24-2" tabindex="-1"></a>result_0 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(D <span class="sc">~</span> w1, <span class="at">data =</span> df, <span class="at">method =</span> <span class="cn">NULL</span>, <span class="at">distance =</span> <span class="st">&#39;glm&#39;</span>)</span>
<span id="cb24-3"><a href="matching.html#cb24-3" tabindex="-1"></a><span class="fu">summary</span>(result_0)</span></code></pre></div>
<pre><code>## 
## Call:
## matchit(formula = D ~ w1, data = df, method = NULL, distance = &quot;glm&quot;)
## 
## Summary of Balance for All Data:
##          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance        0.6549        0.2493          1.5714     1.2566    0.3685
## w1              0.7004       -0.5362          1.6030     0.9132    0.3685
##          eCDF Max
## distance   0.5761
## w1         0.5761
## 
## Sample Sizes:
##           Control Treated
## All          5806    4194
## Matched      5806    4194
## Unmatched       0       0
## Discarded       0       0</code></pre>
<p>Cochran, W. G. 1968. “The Effectiveness of Adjustment by Subclassification in Removing Bias in Observational Studies.” Biometrics 24 (2): 295–313.</p>
</div>
<div id="declare-design-e-matching" class="section level2 hasAnchor" number="5.9">
<h2><span class="header-section-number">5.9</span> Declare Design e Matching<a href="matching.html#declare-design-e-matching" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Pode ser útil usar o declare design para investigar o uso de matching. Vamos fazer isso para o dataset lalonde.</p>
<p>Esse é um banco de dados famoso na economia, pois o pesquisador Lalonde (1986) foi investigar se aplicação de métodos (então) tradicionais de modelagem econométrica eram capaz de recuperar o efeito causal de um estudo experimental chamada National Supported Work Demonstration (NSW), um programa de emprego temporário para dar experiência de trabalho. Ele coletou dados de um survey “representativo” de trabalhadores americanos (PSID) e elencou esses trabalhadores como grupo controle e empregou métodos econométricos para tentat estimar o efeito causal. Os resultados foram desastrosos, no sentido de altamente variáveis dependendo do modelo e subconjunto de dados e longe da estimativa experimental (incluindo com sinal errado).</p>
<p>Vamos replicar esse trabalho, usando matching e pscore. A variável resposta do banco de dados é <code>re78</code> (real earnings in 1978). O tratamento é a variável <code>treat</code>. As demais variáveis são covariáveis.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="matching.html#cb26-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb26-2"><a href="matching.html#cb26-2" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb26-3"><a href="matching.html#cb26-3" tabindex="-1"></a><span class="fu">library</span>(here, <span class="at">quietly=</span><span class="cn">TRUE</span>)</span>
<span id="cb26-4"><a href="matching.html#cb26-4" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb26-5"><a href="matching.html#cb26-5" tabindex="-1"></a><span class="fu">here</span>()</span></code></pre></div>
<pre><code>## [1] &quot;/Users/manoelgaldino/Documents/DCP/Cursos/Causalidade/Causalidade&quot;</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="matching.html#cb28-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="matching.html#cb29-1" tabindex="-1"></a>lalonde <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">here</span>(<span class="st">&quot;Dados&quot;</span>, <span class="st">&quot;lalonde_nsw.csv&quot;</span>))</span>
<span id="cb29-2"><a href="matching.html#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="matching.html#cb29-3" tabindex="-1"></a>dt <span class="ot">&lt;-</span> lalonde[, .(re78, treat)] <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="matching.html#cb29-4" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Y =</span> re78, <span class="at">D =</span> treat)</span>
<span id="cb29-5"><a href="matching.html#cb29-5" tabindex="-1"></a></span>
<span id="cb29-6"><a href="matching.html#cb29-6" tabindex="-1"></a>dt <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="matching.html#cb29-7" tabindex="-1"></a>    <span class="fu">group_by</span>(D) <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="matching.html#cb29-8" tabindex="-1"></a>    <span class="fu">sample_n</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-9"><a href="matching.html#cb29-9" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">0</span>, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">&quot;Income&quot;</span>, <span class="st">&quot;Treatment&quot;</span>))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">Income</th>
<th align="right">Treatment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">290</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">7010</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">13830</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">60308</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="matching.html#cb30-1" tabindex="-1"></a>dt <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="matching.html#cb30-2" tabindex="-1"></a>    <span class="fu">group_by</span>(D) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="matching.html#cb30-3" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="fu">mean</span>(Y)) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="matching.html#cb30-4" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">0</span>, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">&quot;Treatment&quot;</span>, <span class="st">&quot;Income&quot;</span>))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">Treatment</th>
<th align="right">Income</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">4555</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">6349</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="matching.html#cb31-1" tabindex="-1"></a>y1 <span class="ot">=</span> dt[dt<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span>, Y]</span>
<span id="cb31-2"><a href="matching.html#cb31-2" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> dt[dt<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">0</span>, Y]</span>
<span id="cb31-3"><a href="matching.html#cb31-3" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1) <span class="sc">-</span> <span class="fu">mean</span>(y0)</span></code></pre></div>
<p>The simple difference in means is 1794.</p>
<div id="matching-e-propensity-scores" class="section level3 hasAnchor" number="5.9.1">
<h3><span class="header-section-number">5.9.1</span> Matching e Propensity scores<a href="matching.html#matching-e-propensity-scores" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Using <code>age, education, hispanic, black, married, nodegree, RE74</code> and <code>RE75</code>, construct a propensity score using the treated group in <code>lalonde_nsw.csv</code> and the control sample of <code>lalonde_psid.csv</code>. Use a logit regression model to do so (you may use a canned routine to run the regression). Report the average p-score for the treated and control samples, and plot the propensity score densities for the treatment and control groups.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="matching.html#cb32-1" tabindex="-1"></a>nsw_data <span class="ot">&lt;-</span> lalonde</span>
<span id="cb32-2"><a href="matching.html#cb32-2" tabindex="-1"></a>psid_data <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">here</span>(<span class="st">&quot;Dados&quot;</span>, <span class="st">&quot;lalonde_psid.csv&quot;</span>))</span>
<span id="cb32-3"><a href="matching.html#cb32-3" tabindex="-1"></a></span>
<span id="cb32-4"><a href="matching.html#cb32-4" tabindex="-1"></a>nsw_treat <span class="ot">&lt;-</span> nsw_data[nsw_data<span class="sc">$</span>treat <span class="sc">==</span> <span class="dv">1</span>, ]</span>
<span id="cb32-5"><a href="matching.html#cb32-5" tabindex="-1"></a>psid_control <span class="ot">&lt;-</span> psid_data[psid_data<span class="sc">$</span>treat <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb32-6"><a href="matching.html#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="matching.html#cb32-7" tabindex="-1"></a>dw_data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(nsw_treat, psid_control)</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="matching.html#cb33-1" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb33-2"><a href="matching.html#cb33-2" tabindex="-1"></a><span class="fu">library</span>(DeclareDesign)</span>
<span id="cb33-3"><a href="matching.html#cb33-3" tabindex="-1"></a>exact_matching <span class="ot">&lt;-</span></span>
<span id="cb33-4"><a href="matching.html#cb33-4" tabindex="-1"></a>  <span class="cf">function</span>(data) {</span>
<span id="cb33-5"><a href="matching.html#cb33-5" tabindex="-1"></a>    matched <span class="ot">&lt;-</span> <span class="fu">matchit</span>(D <span class="sc">~</span> X, <span class="at">method =</span> <span class="st">&quot;exact&quot;</span>, <span class="at">data =</span> data)</span>
<span id="cb33-6"><a href="matching.html#cb33-6" tabindex="-1"></a>    <span class="fu">match.data</span>(matched)</span>
<span id="cb33-7"><a href="matching.html#cb33-7" tabindex="-1"></a>  }</span>
<span id="cb33-8"><a href="matching.html#cb33-8" tabindex="-1"></a></span>
<span id="cb33-9"><a href="matching.html#cb33-9" tabindex="-1"></a>declaration_16<span class="fl">.2</span> <span class="ot">&lt;-</span></span>
<span id="cb33-10"><a href="matching.html#cb33-10" tabindex="-1"></a>  <span class="fu">declare_model</span>(</span>
<span id="cb33-11"><a href="matching.html#cb33-11" tabindex="-1"></a>    <span class="at">N =</span> <span class="dv">100</span>,</span>
<span id="cb33-12"><a href="matching.html#cb33-12" tabindex="-1"></a>    <span class="at">U =</span> <span class="fu">rnorm</span>(N),</span>
<span id="cb33-13"><a href="matching.html#cb33-13" tabindex="-1"></a>    <span class="at">X =</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb33-14"><a href="matching.html#cb33-14" tabindex="-1"></a>    <span class="at">D =</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.25</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> X),</span>
<span id="cb33-15"><a href="matching.html#cb33-15" tabindex="-1"></a>    <span class="at">Y_D_0 =</span> <span class="fl">0.2</span> <span class="sc">*</span> X <span class="sc">+</span> U,</span>
<span id="cb33-16"><a href="matching.html#cb33-16" tabindex="-1"></a>    <span class="at">Y_D_1 =</span> Y_D_0 <span class="sc">+</span> <span class="fl">0.5</span></span>
<span id="cb33-17"><a href="matching.html#cb33-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-18"><a href="matching.html#cb33-18" tabindex="-1"></a>  <span class="fu">declare_inquiry</span>(<span class="at">ATT =</span> <span class="fu">mean</span>(Y_D_1[D <span class="sc">==</span> <span class="dv">1</span>] <span class="sc">-</span> Y_D_0[D <span class="sc">==</span> <span class="dv">1</span>])) <span class="sc">+</span></span>
<span id="cb33-19"><a href="matching.html#cb33-19" tabindex="-1"></a>  <span class="fu">declare_step</span>(<span class="at">handler =</span> exact_matching) <span class="sc">+</span></span>
<span id="cb33-20"><a href="matching.html#cb33-20" tabindex="-1"></a>  <span class="fu">declare_measurement</span>(<span class="at">Y =</span> <span class="fu">reveal_outcomes</span>(Y <span class="sc">~</span> D)) <span class="sc">+</span></span>
<span id="cb33-21"><a href="matching.html#cb33-21" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> D,</span>
<span id="cb33-22"><a href="matching.html#cb33-22" tabindex="-1"></a>                    <span class="at">weights =</span> weights,</span>
<span id="cb33-23"><a href="matching.html#cb33-23" tabindex="-1"></a>                    <span class="at">.method =</span> difference_in_means,</span>
<span id="cb33-24"><a href="matching.html#cb33-24" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATT&quot;</span>,</span>
<span id="cb33-25"><a href="matching.html#cb33-25" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;Matched difference-in-means&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-26"><a href="matching.html#cb33-26" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> D,</span>
<span id="cb33-27"><a href="matching.html#cb33-27" tabindex="-1"></a>                    <span class="at">.method =</span> difference_in_means,</span>
<span id="cb33-28"><a href="matching.html#cb33-28" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATT&quot;</span>,</span>
<span id="cb33-29"><a href="matching.html#cb33-29" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;Raw difference-in-means&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="matching.html#cb34-1" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb34-2"><a href="matching.html#cb34-2" tabindex="-1"></a>m.out0 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> education <span class="sc">+</span> hispanic <span class="sc">+</span> black <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb34-3"><a href="matching.html#cb34-3" tabindex="-1"></a>                  <span class="at">data =</span> dw_data,</span>
<span id="cb34-4"><a href="matching.html#cb34-4" tabindex="-1"></a>                  <span class="at">method =</span> <span class="cn">NULL</span>,</span>
<span id="cb34-5"><a href="matching.html#cb34-5" tabindex="-1"></a>                  <span class="at">distance =</span> <span class="st">&quot;glm&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="matching.html#cb36-1" tabindex="-1"></a><span class="co"># Checking balance prior to matching</span></span>
<span id="cb36-2"><a href="matching.html#cb36-2" tabindex="-1"></a><span class="fu">summary</span>(m.out0)</span></code></pre></div>
<pre><code>## 
## Call:
## matchit(formula = treat ~ age + education + hispanic + black + 
##     married + nodegree + re74 + re75, data = dw_data, method = NULL, 
##     distance = &quot;glm&quot;)
## 
## Summary of Balance for All Data:
##           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance         0.6364        0.0270          2.1674     8.0268    0.4816
## age             25.8162       34.8506         -1.2627     0.4696    0.2317
## education       10.3459       12.1169         -0.8808     0.4255    0.1091
## hispanic         0.0595        0.0325          0.1139          .    0.0269
## black            0.8432        0.2506          1.6301          .    0.5926
## married          0.1892        0.8663         -1.7287          .    0.6771
## nodegree         0.7081        0.3052          0.8862          .    0.4029
## re74          2095.5737    19428.7458         -3.5471     0.1329    0.4684
## re75          1532.0553    19063.3377         -5.4458     0.0561    0.4695
##           eCDF Max
## distance    0.8817
## age         0.3771
## education   0.4029
## hispanic    0.0269
## black       0.5926
## married     0.6771
## nodegree    0.4029
## re74        0.7292
## re75        0.7736
## 
## Sample Sizes:
##           Control Treated
## All          2490     185
## Matched      2490     185
## Unmatched       0       0
## Discarded       0       0</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="matching.html#cb38-1" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb38-2"><a href="matching.html#cb38-2" tabindex="-1"></a>m.out1 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> education <span class="sc">+</span> hispanic <span class="sc">+</span> black <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb38-3"><a href="matching.html#cb38-3" tabindex="-1"></a>                  <span class="at">data =</span> dw_data,</span>
<span id="cb38-4"><a href="matching.html#cb38-4" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>,</span>
<span id="cb38-5"><a href="matching.html#cb38-5" tabindex="-1"></a>                  <span class="at">distance =</span> <span class="st">&quot;glm&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="matching.html#cb40-1" tabindex="-1"></a><span class="co"># Full matching on a probit PS</span></span>
<span id="cb40-2"><a href="matching.html#cb40-2" tabindex="-1"></a>m.out2 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> education <span class="sc">+</span> black <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb40-3"><a href="matching.html#cb40-3" tabindex="-1"></a>                    nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb40-4"><a href="matching.html#cb40-4" tabindex="-1"></a>                  <span class="at">data =</span> lalonde,</span>
<span id="cb40-5"><a href="matching.html#cb40-5" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">&quot;full&quot;</span>,</span>
<span id="cb40-6"><a href="matching.html#cb40-6" tabindex="-1"></a>                  <span class="at">distance =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb40-7"><a href="matching.html#cb40-7" tabindex="-1"></a>                  <span class="at">link =</span> <span class="st">&quot;probit&quot;</span>)</span>
<span id="cb40-8"><a href="matching.html#cb40-8" tabindex="-1"></a></span>
<span id="cb40-9"><a href="matching.html#cb40-9" tabindex="-1"></a>m.data <span class="ot">&lt;-</span> <span class="fu">match_data</span>(m.out2)</span>
<span id="cb40-10"><a href="matching.html#cb40-10" tabindex="-1"></a></span>
<span id="cb40-11"><a href="matching.html#cb40-11" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;marginaleffects&quot;</span>)</span>
<span id="cb40-12"><a href="matching.html#cb40-12" tabindex="-1"></a></span>
<span id="cb40-13"><a href="matching.html#cb40-13" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">*</span> (age <span class="sc">+</span> education <span class="sc">+</span> black <span class="sc">+</span> married <span class="sc">+</span></span>
<span id="cb40-14"><a href="matching.html#cb40-14" tabindex="-1"></a>                            nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75),</span>
<span id="cb40-15"><a href="matching.html#cb40-15" tabindex="-1"></a>          <span class="at">data =</span> m.data,</span>
<span id="cb40-16"><a href="matching.html#cb40-16" tabindex="-1"></a>          <span class="at">weights =</span> weights)</span>
<span id="cb40-17"><a href="matching.html#cb40-17" tabindex="-1"></a></span>
<span id="cb40-18"><a href="matching.html#cb40-18" tabindex="-1"></a><span class="fu">avg_comparisons</span>(fit,</span>
<span id="cb40-19"><a href="matching.html#cb40-19" tabindex="-1"></a>                <span class="at">variables =</span> <span class="st">&quot;treat&quot;</span>,</span>
<span id="cb40-20"><a href="matching.html#cb40-20" tabindex="-1"></a>                <span class="at">vcov =</span> <span class="sc">~</span>subclass,</span>
<span id="cb40-21"><a href="matching.html#cb40-21" tabindex="-1"></a>                <span class="at">newdata =</span> <span class="fu">subset</span>(treat <span class="sc">==</span> <span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 
##  Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
##      2064        679 3.04  0.00238 8.7   733   3396
## 
## Term: treat
## Type:  response 
## Comparison: 1 - 0</code></pre>
</div>
<div id="discovering-a-dgp" class="section level3 hasAnchor" number="5.9.2">
<h3><span class="header-section-number">5.9.2</span> Discovering a DGP<a href="matching.html#discovering-a-dgp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="matching.html#cb42-1" tabindex="-1"></a><span class="fu">library</span>(synthpop)</span>
<span id="cb42-2"><a href="matching.html#cb42-2" tabindex="-1"></a></span>
<span id="cb42-3"><a href="matching.html#cb42-3" tabindex="-1"></a><span class="co"># vars &lt;- c(&quot;treat&quot;,&quot;age&quot;,&quot;education&quot;,&quot;hispanic&quot;,&quot;black&quot;,&quot;married&quot;, &quot;nodegree&quot;, &quot;re74&quot;, &quot;re75&quot;, &quot;re78&quot;)</span></span>
<span id="cb42-4"><a href="matching.html#cb42-4" tabindex="-1"></a><span class="co"># s2 &lt;- syn(dw_data, method = &quot;parametric&quot;, seed = 123)</span></span>
<span id="cb42-5"><a href="matching.html#cb42-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb42-6"><a href="matching.html#cb42-6" tabindex="-1"></a><span class="co"># # Generate synthetic data with customized methods</span></span>
<span id="cb42-7"><a href="matching.html#cb42-7" tabindex="-1"></a><span class="co"># syn_result &lt;- syn(original_data, method = synth_methods)</span></span>
<span id="cb42-8"><a href="matching.html#cb42-8" tabindex="-1"></a><span class="co"># synthetic_data &lt;- syn_result$syn</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="matching.html#cb43-1" tabindex="-1"></a>full_matching <span class="ot">&lt;-</span></span>
<span id="cb43-2"><a href="matching.html#cb43-2" tabindex="-1"></a>  <span class="cf">function</span>(data) {</span>
<span id="cb43-3"><a href="matching.html#cb43-3" tabindex="-1"></a>    matched <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> education <span class="sc">+</span> hispanic <span class="sc">+</span> black <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, <span class="at">method =</span> <span class="st">&quot;full&quot;</span>, <span class="at">data =</span> data)</span>
<span id="cb43-4"><a href="matching.html#cb43-4" tabindex="-1"></a>    <span class="fu">match.data</span>(matched)</span>
<span id="cb43-5"><a href="matching.html#cb43-5" tabindex="-1"></a>  }</span>
<span id="cb43-6"><a href="matching.html#cb43-6" tabindex="-1"></a></span>
<span id="cb43-7"><a href="matching.html#cb43-7" tabindex="-1"></a>declaration_16<span class="fl">.2</span> <span class="ot">&lt;-</span></span>
<span id="cb43-8"><a href="matching.html#cb43-8" tabindex="-1"></a>  <span class="fu">declare_model</span>(</span>
<span id="cb43-9"><a href="matching.html#cb43-9" tabindex="-1"></a>    <span class="at">N =</span> <span class="dv">1000</span>,</span>
<span id="cb43-10"><a href="matching.html#cb43-10" tabindex="-1"></a>    <span class="at">U =</span> <span class="fu">rnorm</span>(N),</span>
<span id="cb43-11"><a href="matching.html#cb43-11" tabindex="-1"></a>    <span class="at">X =</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb43-12"><a href="matching.html#cb43-12" tabindex="-1"></a>    <span class="at">D =</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.25</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> X),</span>
<span id="cb43-13"><a href="matching.html#cb43-13" tabindex="-1"></a>    <span class="at">Y_D_0 =</span> <span class="fl">0.2</span> <span class="sc">*</span> X <span class="sc">+</span> U,</span>
<span id="cb43-14"><a href="matching.html#cb43-14" tabindex="-1"></a>    <span class="at">Y_D_1 =</span> Y_D_0 <span class="sc">+</span> <span class="fl">0.5</span></span>
<span id="cb43-15"><a href="matching.html#cb43-15" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-16"><a href="matching.html#cb43-16" tabindex="-1"></a>  <span class="fu">declare_inquiry</span>(<span class="at">ATT =</span> <span class="fu">mean</span>(Y_D_1[D <span class="sc">==</span> <span class="dv">1</span>] <span class="sc">-</span> Y_D_0[D <span class="sc">==</span> <span class="dv">1</span>])) <span class="sc">+</span></span>
<span id="cb43-17"><a href="matching.html#cb43-17" tabindex="-1"></a>  <span class="fu">declare_step</span>(<span class="at">handler =</span> exact_matching) <span class="sc">+</span></span>
<span id="cb43-18"><a href="matching.html#cb43-18" tabindex="-1"></a>  <span class="fu">declare_measurement</span>(<span class="at">Y =</span> <span class="fu">reveal_outcomes</span>(Y <span class="sc">~</span> D)) <span class="sc">+</span></span>
<span id="cb43-19"><a href="matching.html#cb43-19" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> D,</span>
<span id="cb43-20"><a href="matching.html#cb43-20" tabindex="-1"></a>                    <span class="at">weights =</span> weights,</span>
<span id="cb43-21"><a href="matching.html#cb43-21" tabindex="-1"></a>                    <span class="at">.method =</span> difference_in_means,</span>
<span id="cb43-22"><a href="matching.html#cb43-22" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATT&quot;</span>,</span>
<span id="cb43-23"><a href="matching.html#cb43-23" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;Matched difference-in-means&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-24"><a href="matching.html#cb43-24" tabindex="-1"></a>  <span class="fu">declare_estimator</span>(Y <span class="sc">~</span> D,</span>
<span id="cb43-25"><a href="matching.html#cb43-25" tabindex="-1"></a>                    <span class="at">.method =</span> difference_in_means,</span>
<span id="cb43-26"><a href="matching.html#cb43-26" tabindex="-1"></a>                    <span class="at">inquiry =</span> <span class="st">&quot;ATT&quot;</span>,</span>
<span id="cb43-27"><a href="matching.html#cb43-27" tabindex="-1"></a>                    <span class="at">label =</span> <span class="st">&quot;Raw difference-in-means&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="matching.html#cb44-1" tabindex="-1"></a><span class="co"># logit_model &lt;- feglm(treat ~ age + education + hispanic + black + married + nodegree + re74 + re75, data = dw_data, family = &quot;binomial&quot;)</span></span>
<span id="cb44-2"><a href="matching.html#cb44-2" tabindex="-1"></a><span class="co"># pscore_logit &lt;- predict(logit_model, dw_data)</span></span>
<span id="cb44-3"><a href="matching.html#cb44-3" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb44-4"><a href="matching.html#cb44-4" tabindex="-1"></a><span class="co"># dw_data %&gt;%</span></span>
<span id="cb44-5"><a href="matching.html#cb44-5" tabindex="-1"></a><span class="co">#     bind_cols(tibble(pscore_logit = pscore_logit)) %&gt;%</span></span>
<span id="cb44-6"><a href="matching.html#cb44-6" tabindex="-1"></a><span class="co">#     group_by(treat) %&gt;%</span></span>
<span id="cb44-7"><a href="matching.html#cb44-7" tabindex="-1"></a><span class="co">#     summarize(pscore_logit = mean(pscore_logit))</span></span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="experimentos.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="variáveis-instrumentais.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/mgaldino/Causalidade/edit/main/05-Matching.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/mgaldino/Causalidade/blob/main/05-Matching.Rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
